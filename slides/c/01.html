<!doctype html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="utf-8">
		<title>C语言的指针与数组</title>
		<link rel="stylesheet" href="../../reveal.js/dist/reveal.css">
		<link rel="stylesheet" href="../../reveal.js/dist/theme/white.css" id="theme">
		<link rel="stylesheet" href="../../reveal.js/plugin/highlight/monokai.css">
		<link rel="stylesheet" href="../../css/grid.css">
	</head>

	<body>
		<div class="reveal">
			<div class="slides">
				<section data-background="../assets/bjtu.svg" data-background-size="40%" data-background-opacity="0.08">
					<h1>C语言的指针与数组</h>
				</section>

				<section  data-transition="zoom">
					<h2 class="r-fit-text">指针和数组</h2>
					<h2 class="r-fit-text" style="color: #EC4899;">关系似乎非常密切，经常把人绕晕</h2>
					<ul>
						<li>数组名可当作指针使用</li>
						<li>数组表达式亦可解释为指针运算</li>
						<li>但它们又不是一回事</li>
					</ul>
				</section>

			<section>
				<h2 class="r-fit-text" style="color: #EC4899;">到底该怎样理解它们之间的关系</h2>
				<h2 class="r-fit-text">?</h2>
			</section>

			<section>
					<ul>
						<li>计算机的存储系统由一系列的存储单元组成</li>
						<li class="fragment" data-fragment-index="1">每个存储单元有对应的编号，即<b>地址</b></li>
						<li class="fragment" data-fragment-index="5">为了方便存取，我们可以给某些存储单元加标签。这些标签即<b>变量</b></li>
						<li class="fragment" data-fragment-index="6">单元格中存储的数据即变量的<b>值</b></li>
					</ul>

					<div style="height: 50px;"></div>

					<div class="container", style="grid-template-columns: repeat(10, 6vw); grid-template-rows: 3vw 6vw 2vw">
						<div></div>
						<div></div>
						<div class="fragment" data-fragment-index="5">n</div>
						<div></div>
						<div></div>
						<div class="fragment" data-fragment-index="5">size</div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"><span class="fragment" data-fragment-index="6">43</span></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"><span class="fragment" data-fragment-index="6">100</span></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="fragment" data-fragment-index="1">0</div>
						<div class="fragment" data-fragment-index="2">1</div>
						<div class="fragment" data-fragment-index="3">2</div>
						<div class="fragment" data-fragment-index="4">3</div>
						<div class="fragment" data-fragment-index="4">4</div>
						<div class="fragment" data-fragment-index="4">5</div>
						<div class="fragment" data-fragment-index="4">6</div>
						<div class="fragment" data-fragment-index="4">7</div>
						<div class="fragment" data-fragment-index="4">8</div>
						<div class="fragment" data-fragment-index="4">9</div>
					</div>
				</section>

				<section>
					<h2>变量赋值</h2>
					<pre>
						<code class="c" data-trim data-noescape data-line-numbers="1-2|3|4|5">
						int i, j;

						i = 7;
						j = i + 1;
						i = j;
						</code>
					</pre>
					效果请参看下一张幻灯片
				</section>

				<section>
					<h2>变量赋值</h2>
					<div class="container", style="margin: auto; width: 22vw; column-gap: 10vw; grid-template-columns: 6vw 6vw; grid-template-rows: 3vw 6vw">
						<div>i</div>
						<div>j</div>
						<div class="box-10"><div class="fragment" data-fragment-index="1">7</div><div class="fragment overlay" data-fragment-index="3">8</div></div>
						<div class="box-10"><span class="fragment" data-fragment-index="2">8</span></div>
					</div>
				</section>

				<section>
					<ul>
						<li>数据有各种类型</li>
						<li>不同的数据类型占用的存储单元个数可能不一样</li>
					<ul>
					<div style="height: 50px;"></div>
					<div class="container", style="gap: 2vw; grid-template-columns: 4vw 16vw 32vW; grid-template-rows: 3vw 4vw">
						<div>char</div>
						<div>int</div>
						<div>long</div>
						<div class="box-10">x</div>
						<div class="box-10">139</div>
						<div class="box-10">498256395</div>
					</div>
				</section>

				<section>
					<h2>掌握</h2>
					<h2 class="r-fit-text">数据类型</h2>
					<h2 class="r-fit-text">概念是学好C语言，乃至其他语言的关键之一</h2>
				</section>

				<section>
					<h2>指针</h2>
					<ul>
						<li>指针是一种数据类型，其中存储的数据是内存地址单元的编号</li>
						<li>指针中记录的地址对应的数据也有类型</li>
						<li>在现代64位计算机系统中，一个指针数据类型通常占用8个字节</li>
						<li>可以用<code>sizeof(p)</code>测试指针的大小</li>
						<li>可以用<code>sizeof(*p)</code>测试指针指向的数据类型的大小</li>
					</ul>
				</section>

				<section>
					<h2>指针赋值</h2>
					<pre>
						<code class="c" data-trim data-noescape data-line-numbers="1-3|4|5|6">
						int i;
						int *p;

						i = 7;
						p = &i;
						*p = 8;
						</code>
					</pre>
					效果请参看下一张幻灯片
				</section>

				<section>
					<h2>指针赋值</h2>
					<ul>
						<li class="fragment" data-fragment-index="1"><code>i = 7;</code></li>
						<li class="fragment" data-fragment-index="2"><code>p = &i;</code></li>
						<li class="fragment" data-fragment-index="3"><code>*p = 8;</code></li>
					</ul>
					<div style="height: 50px;"></div>
					<div class="container", style="margin: auto; width: 30vw; column-gap: 10vw; grid-template-columns: 6vw 12vw; grid-template-rows: 3vw 6vw 2vw">
						<div>i</div>
						<div>p</div>
						<div class="box-10"><div class="fragment" data-fragment-index="1">7</div><div class="fragment overlay" data-fragment-index="3">8</div></div>
						<div id="end" class="box-10"><span class="fragment" data-fragment-index="2">1258</span></div>
						<div>1258</div>
						<div></div>
					</div>
				</section>

				<section>
					<h2>指针类型</h2>
					<ul>
						<li class="fragment" data-fragment-index="1">C是强类型语言</li>
						<li class="fragment" data-fragment-index="2">在声明变量时，必须指定其类型</li>
						<li class="fragment" data-fragment-index="3">指针类型也不例外，你必须声明它是指向什么数据类型的指针</li>
						<li class="fragment" data-fragment-index="4">指针运算是基于数据类型的</li>
					</ul>
				</section>

				<section>
					<h2>指针类型</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							int    *ip;    /* pointer to an integer */
							double *dp;    /* pointer to a double */
							float  *fp;    /* pointer to a float */
							char   *ch;    /* pointer to a character */
							int  **ipp;    /* pointer to a pointer to an integer */
							void (*f)();   /* pointer to a function */
						</code>
					</pre>
					<h2 class="r-fit-text">这都是些什么呀?</h2>
				</section>

				<section>
					<h2>类型解读</h2>
					<ul>
						<li>曾经有一个顺时针右旋法则<a href="http://c-faq.com/decl/spiral.anderson.html">Clockwise/Spiral Rule</a></li>
						<li>但有时会错：<a href="https://stackoverflow.com/questions/16260417/the-spiral-rule-about-declarations-when-is-it-in-error">The spiral rule about declarations — when is it in error?</a></li>
						<li>这个可以参考：<a href="https://www.geeksforgeeks.org/complicated-declarations-in-c/">Complicated declarations in C</a></li>
						<li>不用难为情，很多人都会搞错。相信我，认真学完这个幻灯片，你就是高手了。如有不懂，一定要问！</li>
					</ul>
				</section>

				<section>
					<h2>变量类型</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							int (*fp) ();
							int (*daytab)[13];
							void (*f[10]) (int, int);
							char (*(*x())[]) ();
							char (*(*x[3])())[5];
							int *(*(*arr[5])()) ();
						</code>
					</pre>
					<p>这些更变态，不过不用怕，咱们有法宝！</p>
				</section>

				<section>
					<h2>简单总结</h2>
					<ul>
						<li>准确说，应该是右侧优先法则</li>
						<li>从变量名开始，先右后左，遇到括号折返，如此反复</li>
						<li>记下此过程中遇到的符号顺序，然后解读：这些符号都是变量名的修饰语，修饰语的位置与记录的符号位置一致</li>
					</ul>
				</section>

				<section>
					<h2><code>int (*fp) ()</code></h2>
					<ul>
						<li>符号顺序：<code>fp * () int</code></li>
						<li class="fragment" data-fragment-index="1"><code>fp</code>是指针</li>
						<li class="fragment" data-fragment-index="2"><code>fp</code>是函数指针</li>
						<li class="fragment" data-fragment-index="3"><code>fp</code>是返回值为整数的函数指针</li>
					</ul>
				</section>

				<section>
					<h2><code>int (*daytab)[13]</code></h2>
					<ul>
						<li>符号顺序：<code>daytab * [13] int</code></li>
						<li class="fragment" data-fragment-index="1"><code>daytab</code>是指针</li>
						<li class="fragment" data-fragment-index="2"><code>daytab</code>是指向长度为13的数组的指针</li>
						<li class="fragment" data-fragment-index="3"><code>daytab</code>是指向类型为整数且长度为13的数组的指针</li>
					</ul>
				</section>

				<section>
					<h2><code>void (*f[10]) (int, int)</code></h2>
					<ul>
						<li>符号顺序：<code>f [10] * (int, int) void</code></li>
						<li class="fragment" data-fragment-index="1"><code>f</code>是长度为10的数组</li>
						<li class="fragment" data-fragment-index="2"><code>f</code>是长度为10的指针数组（请注意，不是数组指针）</li>
						<li class="fragment" data-fragment-index="3"><code>f</code>是长度为10的（带两个整形参数的）函数指针数组</li>
						<li class="fragment" data-fragment-index="4"><code>f</code>是长度为10的（带两个整形参数，返回值为<code>void</code>的）函数指针数组</li>
					</ul>
				</section>

				<section>
					<h2><code>char (*(*x())[]) ();</code></h2>
					<ul>
						<li>符号顺序：<code>x () * [] * () char</code></li>
						<li class="fragment" data-fragment-index="1"><code>x</code>是不带参数的函数</li>
						<li class="fragment" data-fragment-index="2"><code>x</code>是返回值为指针的不带参数的函数</li>
						<li class="fragment" data-fragment-index="3"><code>x</code>是返回值为数组指针的不带参数的函数</li>
						<li class="fragment" data-fragment-index="4"><code>x</code>是返回值为指针数组指针的不带参数的函数</li>
						<li class="fragment" data-fragment-index="5"><code>x</code>是返回值为函数指针数组指针的不带参数的函数</li>
						<li class="fragment" data-fragment-index="6"><code>x</code>是返回值为（返回值为字符的函数指针数组）指针的不带参数的函数</li>
						<li class="fragment" data-fragment-index="7">警告：术高莫用！</li>						
					</ul>
				</section>

				<section>
					<h2><code>char (*(*x[3])())[5]</code></h2>
					<ul>
						<li>符号顺序：<code>x [3] * () * [5] char</code></li>
						<li class="fragment" data-fragment-index="1"><code>x</code>是长度为3的数组</li>
						<li class="fragment" data-fragment-index="2"><code>x</code>是类型为指针长度为3的数组，或者说是长度为3的指针数组</li>
						<li class="fragment" data-fragment-index="3"><code>x</code>是长度为3的函数指针数组</li>
						<li class="fragment" data-fragment-index="4"><code>x</code>是长度为3的（返回值为指针）的函数指针数组</li>
						<li class="fragment" data-fragment-index="5"><code>x</code>是长度为3的返回值为（长度为5的数组）指针的函数指针数组</li>
						<li class="fragment" data-fragment-index="6"><code>x</code>是长度为3的返回值为长度为5的（字符）数组指针的函数指针数组</li>
					</ul>
				</section>

				<section>
					<h2><code>int *(*(*arr[5])()) ()</code></h2>
					<ul>
						<li>符号顺序：<code>arr ...</code></li>
						<li>自己挑战一下吧！</li>
					</ul>
				</section>

				<section>
					<h2>数据类型声明总结</h2>
					<ul>
						<li>不要写过于复杂的类型声明语句</li>
						<li>如有必要，借助<code>typedef</code>简化类型声明</li>
						<li>解读时，第一句最重要</li>
						<li>每一个新解读出的符号都是次新符号的修饰语</li>
					</ul>
				</section>

				<section>
					<h2>练习</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							char c;
							char *p;
							char (*pa)[3]
						</code>
					</pre>
					<p>请问<code>sizeof(c), sizeof(p), sizeof(*p), sizeof(pa), sizeof(*pa)</code>的值分别是多少?</p>
					<p>提示：如果不确信结果是什么，请通过写程序的方式测试确认。</p>
				</section>

				<section>
					<h2>指针运算</h2>
					<ul>
						<li class="fragment" data-fragment-index="1">指针有类型</li>
						<li class="fragment" data-fragment-index="2">数据类型有大小</li>
						<li class="fragment" data-fragment-index="3">假设有指针 <code>p</code>，那么 <code>p + n</code> 这个表达式的<b>值</b>定义为：
							<code>p + n * sizeof(*p)</code></li>
						<li class="fragment" data-fragment-index="4">理解了这个定义，你就理解了有关指针运算的一切</li>
					</ul>
				</section>

				<section>
					<h2>指针运算</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							int main() {
								int i;
								int *p1, *p2;

								p1 = &i
								p2 = p1 + 5;
								printf("%p %p\n", p1, p2);
								printf("%ld\n", p2 - p1);

								return 0;
							}
						</code>
					</pre>
					<p>这个程序打印了两个指针的值，以及它们之间的差值。你能预测出结果吗？</p>
				</section>

				<section>
					<h2>数组</h2>
					<p>C语言中，数组是一个多个同种类型的数据在内存中连续存储的数据结构。所以，在定义数组时，既要指明大小，也要指定类型。例如：</p>
					<pre>
						<code class="c" data-trim data-noescape>
							char name[5];  /* 长度为5的字符数组 */
							int score[3];   /* 长度为3的整数数组 */
						</code>
					</pre>

					<div class="container", style="grid-template-columns: repeat(5, 6vw); grid-template-rows: 3vw 6vw">
						<div>name</div>
						<div></div>
						<div></div>
						<div></div>
						<div></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
					</div>
					<div class="container", style="grid-template-columns: repeat(3, 25vw); grid-template-rows: 3vw 6vw">
						<div style="text-align: left">score</div>
						<div></div>
						<div></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
						<div class="box-10"></div>
					</div>
				</section>

				<section>
					<h2>数组变量</h2>
					<ul>
						<li class="fragment" data-fragment-index="1">C语言里，数组变量比较特别，它不能用在赋值表达式的左侧</li>
						<li class="fragment" data-fragment-index="2">在表达式中引用数组名时，C语言把它解释为指针，指向数组中第一个元素</li>
						<li class="fragment" data-fragment-index="3">可以对数组变量进行取地址操作，得到的是一个数组指针</li>
					</ul>
				</section>

				<section>
					<h2>数组</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							int main() {
								int a[10];
								int *p;
								int (*q)[10];

								p = a;     /* 这时 p 指向 a[0] */
								p = a + 3; /* 这时 p 指向 a[3] */
								p = &a[1]; /* 这时 p 指向 a[1] */
								p = &a;    /* 类型不匹配，p是整数指针，&a是数组指针 */
								q = &a;    /* ok */

								return 0;
							}
						</code>
					</pre>
					<p>a 是指向数组首元素的指针，&a 是数组指针。请问它们的<b>值</b>之间有什么关系？</p>
				</section>

				<section>
					<h2>数组表达式</h2>
					<div>a[n] 等价于 *(a + n)</div>
				</section>

				<section>
					<h2>二维及高维数组</h2>
					<ul>
						<li class="fragment" data-fragment-index="1">C语言没有二维及高维数组的概念</li>
						<li class="fragment" data-fragment-index="2">用C语言的数组类型可以轻松定义出二维及高维数组</li>
						<li class="fragment" data-fragment-index="3">数组的数组即二维数组</li>
						<li class="fragment" data-fragment-index="4">数组的数组的数组即三维数组</li>
						<li class="fragment" data-fragment-index="5">......</li>
					</ul>
				</section>

				<section>
					<h2><code>char a[2][3]</code></h2>
					<ul>
						<li>符号顺序：<code>a [2] [3] char</code></li>
						<li class="fragment" data-fragment-index="1"><code>a</code>是长度为2的数组</li>
						<li class="fragment" data-fragment-index="2"><code>a</code>是长度为2的数组，每个数组元素是一个长度为3的数组</li>
						<li class="fragment" data-fragment-index="3"><code>a</code>是长度为2的数组，每个数组元素是一个长度为3的字符数组</li>
					</ul>

					<div class="container", style="margin: auto; width: 50vw; column-gap: 1vw; grid-template-columns: 20vw 20vw; grid-template-rows: 3vw 6vw">
						<div>a[0]</div>
						<div>a[1]</div>
						<div class="box-10">
							<div class="container fragment",  data-fragment-index="3", style="column-gap: 1vw; grid-template-columns: 6vw 6vw 6vw; grid-template-rows: 5vw">
								<div>a</div>
								<div>b</div>
								<div>c</div>
							</div>
						</div>
						<div class="box-10">
							<div class="container fragment",  data-fragment-index="3", style="column-gap: 1vw; grid-template-columns: 6vw 6vw 6vw; grid-template-rows: 5vw">
								<div>d</div>
								<div>e</div>
								<div>f</div>
							</div>
						</div>
					</div>
				</section>

				<section>
					<h2>指针与数组小结</h2>
					<ul>
						<li class="fragment" data-fragment-index="1">C语言没有二维及高维数组的概念</li>
						<li class="fragment" data-fragment-index="2">所谓的二维及高维数组其实就是数组的数组</li>
						<li class="fragment" data-fragment-index="3">数组名可指代数组本身，也可是指向数组首元素的指针。
							这可能是最让人困惑的地方，随后有例子加以说明
						</li>
						<li class="fragment" data-fragment-index="4">对于指针p, *(p + i) 等价于 p[i]</li>
						<li class="fragment" da，ta-fragment-index="5">理解数据类型的概念非常重要</li>
					</ul>
				</section>

				<section>
					<h2>请问这段代码有问题吗？</h2>
					<pre>
						<code class="c" data-trim data-noescape>
							#include &lt;stdio.h>

							int main(int argc, char* argv[]) {
							    int a[3][4];
							    int** p = (int**)a;
														
							    a[1][1] = 1;
							    int x = *(*(p+1)+1);
							    printf("x: %d\n", x);
							    
							    return 0;
							}
						</code>
					</pre>
					<p>请问打印出的值是 1 吗？</p>
				</section>

				<section>
					<ul>
						<li>前述代码的问题出在这一行：<code>int** p = (int**)a;</code></li>
						<li>p 的类型是指针的指针，a 的类型是数组的数组，两者类型不同，强制转换是错误的</li>
					</ul>
				</section>

				<section>
					<pre>
						<code class="c" data-trim data-noescape>
							#include &lt;stdio.h>

							int main() {
							    int a[3][4];
							
							    /* 在C语言中，数组名可指代其首元素地址，它的类型由数组元素类型决定。如下两例：
							     * 第一例中，a[0]是整数数组，a[0]可指代其首元素地址，即a[0][0]的地址，类型为整数指针
							     * 第二例中，a是二维数组，即数组的数组，a可指代其首元素地址，即a[0]的地址，类型为数组指针
							     */
							    int *pInt = a[0];
							    int (*pArray)[4] = a;
							
							    /* 在C语言中，数组名亦可指代数组本身，这本就天经地义
							     * 第一例中，数组名取地址就得到了一个二维数组指针
							     * 第二例中，sizeof(a)得到的是整个二维数组占用的内存大小
							     */
							    int (*pArrayArray)[3][4] = &a;
							    unsigned int size = sizeof(a);
							
							    /* 下例是错误的，因为它把a看作了指针的数组(a实际上是数组的数组)
							     * int **p = a 是无法通过编译器的检查的
							     * 编译器要求强制类型转换实际上就是一个危险信号
							     */
							    int **p = (int**)a;
							
							    /* 总结：
							     * 在数值上，&a、a以及a[0]完全相同，但它们的类型各不相同
							     */
							
							    return 0;
							}
						</code>
					</pre>
					<p>请运行上面的程序进行验证。如有疑惑，也可以修改它然后测试。</p>
				</section>


				<section>
					<pre>
						<code class="c" data-trim data-noescape>
							#include &lt;stdio.h>

							int main(int argc, char* argv[]) {
							    int a[3][4];
							    int **p;
								
								/* p 的初始化代码省略 */
							    a[1][1] = 1;
							    p[1][1] = 2;
							    
							    return 0;
							}
						</code>
					</pre>
					<p>以上访问 a 和 p 的代码形式上完全一样，但由于数据类型不同，你能说出它们之间的区别吗？这个问题对初学者来说有点难度，但非常重要，请务必理解消化。</p>
				</section>

			</div>
		</div>

		<script src="../../reveal.js/dist/reveal.js"></script>
		<script src="../../reveal.js/plugin/math/math.js"></script>
        <script src="../../reveal.js/plugin/markdown/markdown.js"></script>
		<script src="../../reveal.js/plugin/highlight/highlight.js"></script>
		<script>
			Reveal.initialize({
				plugins: [ RevealMarkdown, RevealMath.KaTeX, RevealHighlight ]
			});
		</script>


	</body>
</html>
